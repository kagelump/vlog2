name: Build Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install .

    - name: Build Executables
      run: |
        # Find mlx.metallib path
        MLX_METALLIB=$(python -c "import os, mlx; print(os.path.join(list(mlx.__path__)[0], 'lib', 'mlx.metallib'))")
        echo "Found mlx.metallib at: $MLX_METALLIB"

        # Build TVAS (Main App)
        pyinstaller --noconfirm --clean \
            --name tvas \
            --add-data "src/tvas/prompts/*.txt:tvas/prompts" \
            --add-data "$MLX_METALLIB:." \
            --collect-all mlx \
            --collect-all mlx_vlm \
            --collect-all toga \
            --hidden-import=tvas \
            --hidden-import=tvas.main \
            src/tvas/main.py

        # Build TPRS (Photo Rating CLI)
        pyinstaller --noconfirm --clean \
            --name tprs \
            --add-data "src/tvas/prompts/*.txt:tvas/prompts" \
            --add-data "$MLX_METALLIB:." \
            --collect-all mlx \
            --collect-all mlx_vlm \
            --collect-all toga \
            --hidden-import=tvas \
            --hidden-import=tvas.tprs_cli \
            src/tvas/tprs_cli.py

    - name: Package Release
      run: |
        DIST_NAME="tvas_release"
        mkdir -p "$DIST_NAME"
        
        # Copy executables
        cp -r dist/tvas "$DIST_NAME/"
        cp -r dist/tprs "$DIST_NAME/"
        
        # Copy README
        cp README.md "$DIST_NAME/"
        
        # Create install script
        cat << EOF > "$DIST_NAME/install.sh"
        #!/bin/bash
        echo "You can run the tools directly from this folder:"
        echo "  ./tvas/tvas"
        echo "  ./tprs/tprs"
        echo ""
        echo "To install to /usr/local/bin (requires sudo):"
        echo "  sudo ln -sf \$(pwd)/tvas/tvas /usr/local/bin/tvas"
        echo "  sudo ln -sf \$(pwd)/tprs/tprs /usr/local/bin/tprs"
        EOF
        chmod +x "$DIST_NAME/install.sh"
        
        # Zip it
        zip -r tvas_mac_release.zip "$DIST_NAME"

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: tvas_mac_release
        path: tvas_mac_release.zip

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: tvas_mac_release.zip
